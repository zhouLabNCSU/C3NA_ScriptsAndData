---
title: "Supplement Figures "
author: "Kuncheng Song"
date: "2/24/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 0. Library
```{r, include=FALSE}
library(C3NA)
```

## 1. Supplementary Figures and Main Figure 1 Workflow Figures
The module patterns, silhouette, consensus and correlation plots are generated using the shiny application with the C3NA::moduleEvals(). Minor edits on the figures were done to adjust the titles. 

### 1.1 Download Pre-Compiled Data from GitHub
```{r}
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Baxter_DADA2_Cancer.rds")
baxterDADA2Cancer <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Baxter_deNovo_Cancer.rds")
baxterDeNovoCancer <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Baxter_DADA2_Normal.rds")
baxterDADA2Normal <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Baxter_deNovo_Normal.rds")
baxterDeNovoNormal <- readRDS(url(githubURL, method="libcurl"))

githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Zeller_DADA2_Cancer.rds")
zellerDADA2Cancer <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Zeller_deNovo_Cancer.rds")
zellerDeNovoCancer <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Zeller_DADA2_Normal.rds")
zellerDADA2Normal <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Zeller_deNovo_Normal.rds")
zellerDeNovoNormal <- readRDS(url(githubURL, method="libcurl"))

githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Gevers_DADA2_CD.rds")
geversDADA2CD <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Gevers_deNovo_CD.rds")
geversDeNovoCD <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Gevers_DADA2_no.rds")
geversDADA2no <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Gevers_deNovo_no.rds")
geversDeNovono <- readRDS(url(githubURL, method="libcurl"))

githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/IBDMDB_DADA2_CD.rds")
IBDMDBDADA2CD <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/IBDMDB_deNovo_CD.rds")
IBDMDBDeNovoCD <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/IBDMDB_DADA2_nonIBD.rds")
IBDMDBDADA2nonIBD <- readRDS(url(githubURL, method="libcurl"))
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/IBDMDB_deNovo_nonIBD.rds")
IBDMDBDeNovononIBD <- readRDS(url(githubURL, method="libcurl"))
```

### 1.2 Call shiny application and extract plots. 
The patterns and silhouette plots were extracted and combined together later to form the supplementary figure version to same spaces.
```{r, eval = FALSE}
moduleEvals(C3NAObj = baxterDADA2Cancer)
moduleEvals(C3NAObj = baxterDeNovoCancer)
moduleEvals(C3NAObj = baxterDADA2Normal)
moduleEvals(C3NAObj = baxterDeNovoNormal)

moduleEvals(C3NAObj = zellerDADA2Cancer)
moduleEvals(C3NAObj = zellerDeNovoCancer)
moduleEvals(C3NAObj = zellerDADA2Normal)
moduleEvals(C3NAObj = zellerDeNovoNormal)

moduleEvals(C3NAObj = geversDADA2CD)
moduleEvals(C3NAObj = geversDeNovoCD)
moduleEvals(C3NAObj = geversDADA2no)
moduleEvals(C3NAObj = geversDeNovono)

moduleEvals(C3NAObj = IBDMDBDADA2CD)
moduleEvals(C3NAObj = IBDMDBDeNovoCD)
moduleEvals(C3NAObj = IBDMDBDADA2nonIBD)
moduleEvals(C3NAObj = IBDMDBDeNovononIBD)
```

## 2. Main Figure 2 Plots
### 2.1 Main Figure 2A
Duplicated legend is removed mnually and the x axis label were manually adjust to top of the plot. 
```{r}
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/SupplementaryPlotData/MainF2A.rdata")
load(url(githubURL, method="libcurl"))
png(filename = paste0("./renderedPlots/MainFig2A.png"),
    width = 13, height = 11, res = 300, units = "in")
setHook("grid.newpage", function() pushViewport(viewport(x=1,y=1,width=0.9, height=0.9, name="vp", just=c("right","top"))), action="prepend")
pheatmap(mat = as.matrix(consensusResult_Wide_C2_Combo), 
         display_numbers = as.matrix(consensusResult_Wide_C2_CorTable),
         cluster_rows = F, cluster_cols = F, 
         annotation_row = cancerCat_colData_left,
         annotation_col = cancerCat_colData_top,
         annotation_colors = colors
         )
setHook("grid.newpage", NULL, "replace")
grid.text("Baxter et al. with de novo OTUs Assignment Method", y=-0.02, gp=gpar(fontsize=12))
grid.text("Baxter et al. with DADA2 ASVs Assignment Method", x=-0.02, rot=90, gp=gpar(fontsize=12))
dev.off()
```

### 2.2 Main Figure 2B
Duplicated legend is removed mnually and the x axis label were manually adjust to top of the plot. 
```{r}
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/SupplementaryPlotData/MainF2B.rdata")
load(url(githubURL, method="libcurl"))
png(filename = paste0("./renderedPlots/MainFig2B.png"),
    width = 13, height = 11, res = 300, units = "in")
setHook("grid.newpage", function() pushViewport(viewport(x=1,y=1,width=0.9, height=0.9, name="vp", just=c("right","top"))), action="prepend")
pheatmap(mat = as.matrix(consensusResult_Wide_C2_Combo), 
         display_numbers = as.matrix(consensusResult_Wide_C2_CorTable),
         cluster_rows = F, cluster_cols = F, 
         annotation_row = cancerCat_colData_left,
         annotation_col = cancerCat_colData_top,
         annotation_colors = colors
         )
setHook("grid.newpage", NULL, "replace")
grid.text("Gevers et al. with de novo OTUs Assignment Method", y=-0.02, gp=gpar(fontsize=12))
grid.text("Gevers et al. with DADA2 ASVs Assignment Method", x=-0.02, rot=90, gp=gpar(fontsize=12))
dev.off()
```

### 2.3 Main Figure 2C
The plot was generated using the C3NA::compareTwoPhenoShiny(). The plot loads the following Baxter et al. and select g_Bacteroides in the 'Taxa Selector'. For better visualization, the edge label is adjusted to 1 and the node label was adjusted to 12 and the display mode is adjusted to 'All taxa directly related to selected taxa'. 
```{r, eval = FALSE}
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Baxter_DADA2_CancerVsNormal.rds")
baxterDADA2CancerVsNormal <- readRDS(url(githubURL, method="libcurl"))
C3NA::compareTwoPhenoShiny(baxterDADA2CancerVsNormal)
```

### 2.4 Main Figure 2D
The plot was generated using the C3NA::compareTwoPhenoShiny(). The plot loads the following Baxter et al. and select g_Bacteroides in the 'Taxa Selector'.  For better visualization, the edge label is adjusted to 1 and the node label was adjusted to 12 and the display mode is adjusted to 'All taxa directly related to selected taxa'. 
```{r, eval = FALSE}
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Gevers_DADA2_CDVsno.rds")
geversDADA2CDVsno <- readRDS(url(githubURL, method="libcurl"))
C3NA::compareTwoPhenoShiny(geversDADA2CDVsno)
```

### 2.3 Main Figure 2E
```{r}
load("./SupplementaryPlotData/diseaseRefData.rdata")
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/Baxter_DADA2_CancerVsNormal.rds")
baxterDADA2CancerVsNormal <- readRDS(url(githubURL, method="libcurl"))
cancerTaxaTaxa = baxterDADA2CancerVsNormal$sparccP_Filtered_Combined %>%
  filter((cor_Disease >= 0.2 & Module_Disease == "Intra-Modular") &
           (cor_Control< 0.2 & Module_Control == "Inter-Modular") &
  # filter((cor_Disease >= 0.2) &
           (source %in% CancerTaxa | target %in% CancerTaxa)) %>%
  filter(substring(source, 1, 1) %in% c("p", "g", "s") & substring(target, 1, 1) %in% c("p", "g", "s"))
nodesCancer = baxterDADA2CancerVsNormal$nodes$nodesAll %>%
  filter(TaxaName %in% unlist(unique(cancerTaxaTaxa[, c("source", "target")])))
nodesCancer = merge(nodesCancer, baxterDADA2CancerVsNormal$DA, by = "TaxaName", all.x = TRUE)
nodesCancer = merge(nodesCancer, baxterDADA2CancerVsNormal$C3NA_Wilcoxon[, c("TaxaName", "C3NA")], 
                    all.x = TRUE)
nodesCancer = merge(nodesCancer, cancerCat[, c("matchedTaxa", "CRC Category")], 
                    by.x = "TaxaName", by.y = "matchedTaxa", all.x = TRUE)
nodesCancer = nodesCancer %>% arrange(ClusterID_Disease) %>%
  replace(is.na(.), value = "")
mygraph = graph_from_data_frame(cancerTaxaTaxa[, c("source", "target", "cor_Disease")])
graphOrder = data.frame(
  TaxaName = as.character(V(mygraph)$name),
  igraphID = as.character(V(mygraph))
)
nodesPos = merge(cancerTaxaTaxa, graphOrder, by.x = "source", by.y = "TaxaName", all.x = TRUE)
colnames(nodesPos)[which(colnames(nodesPos) == "igraphID")] = "sourceID"
nodesPos = merge(nodesPos, graphOrder, by.x = "target", by.y = "TaxaName", all.x = TRUE)
colnames(nodesPos)[which(colnames(nodesPos) == "igraphID")] = "targetID"
nodesPos = nodesPos %>%
  filter(source %in% nodesCancer$TaxaName & target %in% nodesCancer$TaxaName)
graphNodes = merge(nodesCancer, graphOrder, by = "TaxaName", all.x = TRUE, sort = FALSE)
graphNodes = graphNodes %>% arrange(ClusterID_Disease)
graphNodes$TaxaName = as.character(graphNodes$TaxaName)
graphNodes$TaxaName = factor(graphNodes$TaxaName, levels = graphNodes$TaxaName)
graphNodes$newID = seq(nrow(graphNodes))
mygraph = graph_from_data_frame(nodesPos[, c("source", "target", "cor_Disease")],
                                vertices = graphNodes[, c("TaxaName", "newID", "colors_Disease")])
arcPlot = 
  ggraph(mygraph, 
         layout="linear", 
         circular = FALSE) + 
  geom_edge_arc(aes(label = round(cor_Disease, digits = 2), hjust = -0.1), color = "#ababab") + 
  geom_node_point(aes(color = colors_Disease), size=8) +
  scale_x_discrete(limits = nodesCancer$TaxaName,
                   labels = nodesCancer$TaxaName) +
  theme_bw() + labs(x = NULL, y = "", title = "Disease-Only Intra-Modular Correlations") + ylim(0, 5) + 
  theme(
    legend.position="none",
    # plot.margin=unit(rep(2,4), "cm")
    plot.title = element_text(hjust = 0.5, size=12, face = "bold"),
    axis.text.x = element_text(color = "white"),
    axis.text.y = element_text(size = 12, face = "bold.italic")
  ) + coord_flip()
curTable = graphNodes %>% map_df(rev) %>%
  dplyr::select(-igraphID, -newID)
curTable[curTable == "FALSE"] = NA
curTable[curTable == ""] = NA
curTable = as.data.frame(curTable)
curTable$TaxaName = factor(curTable$TaxaName, levels = rev(curTable$TaxaName))
tab_base <- ggplot(curTable, aes(y=TaxaName)) +
    ylab(NULL) + xlab("  ") +
    theme(plot.title = element_text(hjust = 0.5, size=12, face = "bold"), 
        axis.text.x=element_text(color="white"), 
        # axis.line=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.y=element_blank(),legend.position="none",
        panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),plot.background=element_blank())
tab1 <- tab_base +
    geom_label(aes(x=1, label = ClusterID_Disease, color = colors_Disease), fontface = "bold") +
    ggtitle("Cancer")
tab2 <- tab_base +
    geom_label(aes(x=1, label = ClusterID_Control, color = colors_Control), fontface = "bold") +
    ggtitle("Healthy")

tab3 <- tab_base +
    geom_label(aes(x=1, label = ANCOMBC), fill = "#1A77D6", color = "white", fontface = "bold") +
    # geom_label(fill = "red") + 
    ggtitle("ANCOMBC")
tab4 <- tab_base +
    geom_label(aes(x=1, label = ALDEx2,), fill = "#1A77D6", color = "white", fontface = "bold") +
    ggtitle("ALDEx2")
tab5 <- tab_base +
    geom_label(aes(x=1, label = MaAsLin2), fill = "#1A77D6", color = "white", fontface = "bold") +
    ggtitle("MaAsLin2")
tab6 <- tab_base +
    geom_label(aes(x=1, label = C3NA), fill = "#1A77D6", color = "white", fontface = "bold") +
    ggtitle("C3NA")
tab7 <- tab_base +
    geom_label(aes(x=1, label = `CRC Category`), fontface = "bold") +
    ggtitle("Known Functions")

# Figure <- grid.arrange(tab1, tab2, tab3, tab4, tab5, tab6, arcPlot,
#              layout_matrix = matrix(c(rep(1,10),2,2,2), nrow=1))
g <- arrangeGrob(tab1, tab2, tab3, tab4, tab5, tab6, tab7,
                 arcPlot,
                 layout_matrix = matrix(c(1,1,1,2,2,2,3,3,4,4,5,5,6,6,7,7,7,
                                          rep(8,20)), nrow=1))
ggsave(file="./renderedPlots/Main_Figure_2E.png", 
       g, width = 15, height = 15, unit = "in", dpi = 300)
```

### 2.3 Main Figure 2F
```{r}
load("./SupplementaryPlotData/diseaseRefData.rdata")
githubURL <- ("https://github.com/zhouLabNCSU/C3NA_ScriptsAndData/raw/main/moduleEvalsData/IBDMDB_DADA2_CDVsnonIBD.rds")
IBDMDBDADA2CDVsno <- readRDS(url(githubURL, method="libcurl"))
cancerTaxaTaxa = IBDMDBDADA2CDVsno$sparccP_Filtered_Combined %>%
  filter((cor_Disease >= 0.2 & Module_Disease == "Intra-Modular") &
           (cor_Control< 0.2 & Module_Control == "Inter-Modular") &
  # filter((cor_Disease >= 0.2) &
           (source %in% CancerTaxa | target %in% CancerTaxa)) %>%
  filter(substring(source, 1, 1) %in% c("p", "g", "s") & substring(target, 1, 1) %in% c("p", "g", "s"))
nodesCancer = IBDMDBDADA2CDVsno$nodes$nodesAll %>%
  filter(TaxaName %in% unlist(unique(cancerTaxaTaxa[, c("source", "target")])))
nodesCancer = merge(nodesCancer, IBDMDBDADA2CDVsno$DA, by = "TaxaName", all.x = TRUE)
nodesCancer = merge(nodesCancer, IBDMDBDADA2CDVsno$C3NA_Wilcoxon[, c("TaxaName", "C3NA")], 
                    all.x = TRUE)
nodesCancer = merge(nodesCancer, IBDCat[, c("matchedTaxa", "IBD Category")], 
                    by.x = "TaxaName", by.y = "matchedTaxa", all.x = TRUE)
nodesCancer = nodesCancer %>% arrange(ClusterID_Disease) %>%
  replace(is.na(.), value = "")
mygraph = graph_from_data_frame(cancerTaxaTaxa[, c("source", "target", "cor_Disease")])
graphOrder = data.frame(
  TaxaName = as.character(V(mygraph)$name),
  igraphID = as.character(V(mygraph))
)
nodesPos = merge(cancerTaxaTaxa, graphOrder, by.x = "source", by.y = "TaxaName", all.x = TRUE)
colnames(nodesPos)[which(colnames(nodesPos) == "igraphID")] = "sourceID"
nodesPos = merge(nodesPos, graphOrder, by.x = "target", by.y = "TaxaName", all.x = TRUE)
colnames(nodesPos)[which(colnames(nodesPos) == "igraphID")] = "targetID"
nodesPos = nodesPos %>%
  filter(source %in% nodesCancer$TaxaName & target %in% nodesCancer$TaxaName)
graphNodes = merge(nodesCancer, graphOrder, by = "TaxaName", all.x = TRUE, sort = FALSE)
graphNodes = graphNodes %>% arrange(ClusterID_Disease)
graphNodes$TaxaName = as.character(graphNodes$TaxaName)
graphNodes$TaxaName = factor(graphNodes$TaxaName, levels = graphNodes$TaxaName)
graphNodes$newID = seq(nrow(graphNodes))
mygraph = graph_from_data_frame(nodesPos[, c("source", "target", "cor_Disease")],
                                vertices = graphNodes[, c("TaxaName", "newID", "colors_Disease")])
arcPlot = 
  ggraph(mygraph, 
         layout="linear", 
         circular = FALSE) + 
  geom_edge_arc(aes(label = round(cor_Disease, digits = 2), hjust = -0.1), color = "#ababab") + 
  geom_node_point(aes(color = colors_Disease), size=8) +
  scale_x_discrete(limits = nodesCancer$TaxaName,
                   labels = nodesCancer$TaxaName) +
  theme_bw() + labs(x = NULL, y = "", title = "Disease-Only Intra-Modular Correlations") + ylim(0, 5) + 
  theme(
    legend.position="none",
    # plot.margin=unit(rep(2,4), "cm")
    plot.title = element_text(hjust = 0.5, size=12, face = "bold"),
    axis.text.x = element_text(color = "white"),
    axis.text.y = element_text(size = 12, face = "bold.italic")
  ) + coord_flip()
curTable = graphNodes %>% map_df(rev) %>%
  dplyr::select(-igraphID, -newID)
curTable[curTable == "FALSE"] = NA
curTable[curTable == ""] = NA
curTable = as.data.frame(curTable)
curTable$TaxaName = factor(curTable$TaxaName, levels = rev(curTable$TaxaName))
tab_base <- ggplot(curTable, aes(y=TaxaName)) +
    ylab(NULL) + xlab("  ") +
    theme(plot.title = element_text(hjust = 0.5, size=12, face = "bold"), 
        axis.text.x=element_text(color="white"), 
        # axis.line=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.y=element_blank(),legend.position="none",
        panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),plot.background=element_blank())
tab1 <- tab_base +
    geom_label(aes(x=1, label = ClusterID_Disease, color = colors_Disease), fontface = "bold") +
    ggtitle("CD")
tab2 <- tab_base +
    geom_label(aes(x=1, label = ClusterID_Control, color = colors_Control), fontface = "bold") +
    ggtitle("Healthy")

tab3 <- tab_base +
    geom_label(aes(x=1, label = ANCOMBC), fill = "#1A77D6", color = "white", fontface = "bold") +
    # geom_label(fill = "red") + 
    ggtitle("ANCOMBC")
tab4 <- tab_base +
    geom_label(aes(x=1, label = ALDEx2,), fill = "#1A77D6", color = "white", fontface = "bold") +
    ggtitle("ALDEx2")
tab5 <- tab_base +
    geom_label(aes(x=1, label = MaAsLin2), fill = "#1A77D6", color = "white", fontface = "bold") +
    ggtitle("MaAsLin2")
tab6 <- tab_base +
    geom_label(aes(x=1, label = C3NA), fill = "#1A77D6", color = "white", fontface = "bold") +
    ggtitle("C3NA")
tab7 <- tab_base +
    geom_label(aes(x=1, label = `IBD Category`), fontface = "bold") +
    ggtitle("Known Functions")

# Figure <- grid.arrange(tab1, tab2, tab3, tab4, tab5, tab6, arcPlot,
#              layout_matrix = matrix(c(rep(1,10),2,2,2), nrow=1))
g <- arrangeGrob(tab1, tab2, tab3, tab4, tab5, tab6, tab7,
                 arcPlot,
                 layout_matrix = matrix(c(1,1,1,2,2,2,3,3,4,4,5,5,6,6,7,7,7,
                                          rep(8,20)), nrow=1))
ggsave(file="./renderedPlots/Main_Figure_2F.png", 
       g, width = 15, height = 15, unit = "in", dpi = 300)
```










